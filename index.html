<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heat Score Card</title>
    <style>
        table {
            /* width: 100%; */
            /* width: 100%; */
            border-collapse: collapse;
            text-align: center;
        }


        th,

        td {
            border: 1px solid black;
            padding: 0;
        }


        .color-cell {
            height: 30px;
        }


        input {
            /* width: 100%; */
            /* width: 100%; */
            height: 100%;
            text-align: center;
            border: none;
            box-sizing: border-box;
        }


        button {
            margin: 10px;
            padding: 5px 10px;
            font-size: 16px;
        }

        * {
            box-sizing: border-box;
        }

        /* Button used to open the contact form - fixed at the bottom of the page */
        .open-button {
            background-color: #555;
            color: white;
            padding: 16px 20px;
            border: none;
            cursor: pointer;
            opacity: 0.8;
            position: fixed;
            bottom: 23px;
            right: 28px;
            width: 280px;
        }

        /* The popup form - hidden by default */
        .form-popup {
            display: none;
            position: fixed;
            border: 3px solid #f1f1f1;
            z-index: 9;
        }

        /* Add styles to the form container */
        .form-container {
            max-width: 300px;
            padding: 10px;
            background-color: white;
        }

        /* Full-width input fields */
        .form-container input[type=text],
        .form-container input[type=password] {
            width: 100%;
            padding: 15px;
            margin: 5px 0 22px 0;
            border: none;
            background: #f1f1f1;
        }

        /* When the inputs get focus, do something */
        .form-container input[type=text]:focus,
        .form-container input[type=password]:focus {
            background-color: #ddd;
            outline: none;
        }

        /* Set a style for the submit/login button */
        .form-container .btn {
            background-color: #04AA6D;
            color: white;
            padding: 16px 20px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        /* Add a red background color to the cancel button */
        .form-container .cancel {
            background-color: red;
        }

        /* Add some hover effects to buttons */
        .form-container .btn:hover,
        .open-button:hover {
            opacity: 1;
        }
    </style>
</head>


<body onload="loadScores()">
    <h2>Heat:<br>Pedal to the Metal<br>Score Card</h2>
    <table>
        <!-- Score input rows -->
        <script>
            let defaultScoreCard = {
                races: 3,
                scores: [
                    {
                        name: "Red Fred",
                        colorIndex: 3,
                        place: [0, 0, 0],
                        total: 0
                    },
                    {
                        name: "Bluey",
                        colorIndex: 1,
                        place: [0, 0, 0],
                        total: 0
                    },
                ]
            };

            placeNames = ["", "1st", "2nd", "3rd", "4th", "5th", "6th", "7th", "8th", "DNF"];
            placePoints = [0, 9, 6, 4, 3, 2, 1, 0, 0, 0];

            function placeString(place) {
                if (place === 0) return "";
                return `${placeNames[place]} (${placePoints[place]})`;
            }

            let scoreCard = JSON.parse(JSON.stringify(defaultScoreCard));

            let colorNames = ["Yellow", "Blue", "Green", "Red", "Black", "Gray", "Orange", "Purple"];
            let colorValues = ["yellow", "blue", "green", "red", "black", "lightgray", "orange", "purple"];
            let textColors = ["black", "white", "white", "white", "white", "black", "black", "white"];

            document.addEventListener("DOMContentLoaded", buildTable());


            function addPlayerColumn(player, playerIndex) {
                console.log("addPlayerColumn");
                console.log(player);

                let table = document.querySelector("table");
                let nameRow = document.getElementById("nameRow");
                let cell = document.createElement("td");
                cell.classList.add(`color-cell`);
                // cell.id = `name${player.name}`;

                // set the color
                let colorIndex = player.colorIndex;
                cell.style.backgroundColor = colorValues[colorIndex];
                cell.style.color = textColors[colorIndex];

                // set the name
                cell.innerText = player.name;
                cell.onclick = function () { openForm(player, playerIndex); };
                nameRow.appendChild(cell);

                // set the width
                cell.style.width = "100px";

                // add the score cells
                for (let race = 0; race < scoreCard.races; race++) {
                    let row = document.getElementById(`race${race + 1}`);
                    if (!row) {
                        console.log(`race${race + 1} not found`);
                        continue;
                    }
                    let cell = document.createElement("td");
                    cell.onclick = function () { raceCellClick(player, race); };
                    cell.innerText = placeString(player.place[race]);
                    row.appendChild(cell);
                }

                // add the total cell
                let totalRow = document.getElementById("totalRow");
                let totalCell = document.createElement("td");
                totalCell.id = `total_${player}`;
                totalCell.innerText = player.total;
                totalRow.appendChild(totalCell);
            }


            function buildTable() {
                console.log("DOMContentLoaded");
                let table = document.querySelector("table");
                table.id = "scoreTable";

                let nameRow = document.createElement("tr");
                nameRow.id = "nameRow";
                nameRow.appendChild(document.createElement("td"));
                table.appendChild(nameRow);

                for (let race = 1; race <= defaultScoreCard.races; race++) {
                    let row = document.createElement("tr");
                    row.id = `race${race}`;
                    let raceRowHeaderCell = document.createElement("td");
                    raceRowHeaderCell.style.width = "50px";
                    raceRowHeaderCell.innerText = `Race ${race}`;
                    row.appendChild(raceRowHeaderCell);
                    table.appendChild(row);
                }

                // Add total row
                let totalRow = document.createElement("tr");
                totalRow.id = "totalRow";
                let totalCell = document.createElement("td")
                totalCell.innerText = "Total";
                totalRow.appendChild(totalCell);
                table.appendChild(totalRow);

                for (let i = 0; i < scoreCard.scores.length; i++) {
                    console.log(`i = ${i}`);
                    addPlayerColumn(scoreCard.scores[i], i);
                }
            };

            function saveScores() {
                console.log("saveScores");
                document.cookie = `scoreCard=${JSON.stringify(scoreCard)}; path=/; max-age=31536000`;
                console.log(document.cookie);
            }

            function loadScores() {
                console.log("loadScores");
                console.log(document.cookie);
                let cookies = document.cookie.split('; ');
                console.log(cookies);
                let scores = cookies.find(row => row.startsWith('scoreCard='));
                console.log(scores);
                if (scores) {
                    scoreCard = JSON.parse(scores.split('=')[1]);
                } else {
                    scoreCard = JSON.parse(JSON.stringify(defaultScoreCard));
                }
                rebuildTable();
            }
            function rebuildTable() {
                // clear the table
                let table = document.getElementById("scoreTable");
                while (table.firstChild) {
                    table.removeChild(table.firstChild);
                }
                console.log(scoreCard);
                // rebuild the table
                buildTable();
            }

            function raceCellClick(player, race) {
                let cell = event.target;
                let place = player.place[race]
                if (place === 0) {
                    for (let i = 1; i <= 8; i++) {
                        let taken = false;
                        for (let score of scoreCard.scores) {
                            if (score.place[race] === i) {
                                taken = true;
                                break;
                            }
                        }
                        if (!taken) {
                            place = i;
                            break;
                        }
                    }
                } else {
                    place = 0;
                }
                player.place[race] = place;

                let total = 0;
                for (let place of player.place) {
                    total += placePoints[place];
                }
                player.total = total;
                saveScores();
                rebuildTable();
            }
            
            
            function clearScores() {
                if (confirm("Are you sure you want to clear scores?")) {
                    for (score of scoreCard.scores) {
                        for (i = 0; i < score.place.length; i++) {
                            score.place[i] = 0;
                        }
                        score.total = 0;
                    }
                    saveScores();
                    rebuildTable();
                }
            }
            
            function resetScoreCard() {
                if (confirm("Are you sure you want to clear the player names?")) {
                    scoreCard = JSON.parse(JSON.stringify(defaultScoreCard));
                    saveScores();
                    rebuildTable();
                }
            }

            function openForm(player, playerIndex) {
                let cell = event.target;
                let form = document.getElementById("myForm");
                let formNameField = document.getElementById("formNameField");
                formNameField.value = player.name;
                colorIndex = player.colorIndex;

                var colorButton = document.getElementById("colorButton");
                formNameField.style.backgroundColor = colorValues[colorIndex];
                formNameField.style.color = textColors[colorIndex];
                colorButton.onclick = function () {
                    colorIndex = (colorIndex + 1) % colorValues.length;
                    formNameField.style.backgroundColor = colorValues[colorIndex];
                    formNameField.style.color = textColors[colorIndex];
                };

                document.getElementById("removePlayer").checked = false;

                var playerFormSaveButton = document.getElementById("playerFormSaveButton");
                playerFormSaveButton.onclick = function () {
                    player.name = formNameField.value;
                    player.colorIndex = colorIndex;
                    if (document.getElementById("removePlayer").checked) {
                        scoreCard.scores.splice(playerIndex, 1);
                        document.getElementById("addRacer").disabled = false;
                    }
                    closeForm();
                    saveScores();
                    rebuildTable();
                };

                // formNameField.style.backgroundColor = cell.style.backgroundColor;

                // set the form top-left to cell top left
                let rect = cell.getBoundingClientRect();
                form.style.top = `${rect.bottom}px`;
                form.style.left = `${rect.left}px`;

                form.style.display = "block";
            }

            function closeForm() {
                document.getElementById("myForm").style.display = "none";
            }

            function moveColumn(tableId, sourceIndex, targetIndex) {
                const table = document.getElementById(tableId);
                const rows = table.rows;

                for (let i = 0; i < rows.length; i++) {
                    const cells = rows[i].cells;
                    const cellToMove = cells[sourceIndex];

                    rows[i].removeChild(cellToMove);

                    if (targetIndex < sourceIndex) {
                        rows[i].insertBefore(cellToMove, cells[targetIndex]);
                    } else {
                        rows[i].insertBefore(cellToMove, cells[targetIndex + 1]);
                    }
                }
            }

            // Example usage:
            // moveColumn('myTable', 1, 0); // Move column 2 (index 1) to position 1 (index 0)
            function SortColumnsByTotal() {
                scoreCard.scores.sort((a, b) => {
                    if (a.total === b.total) {
                        for (i = a.place.length - 1; i >= 0; i--) {
                            if (a.place[i] !== b.place[i]) {
                                return a.place[i] - b.place[i];
                            }
                        }
                    }
                    return b.total - a.total;
                });
                saveScores();
                rebuildTable();
            }

            function getUnusedColorIndex() {
                let usedColors = scoreCard.scores.map(score => score.colorIndex);
                for (let i = 0; i < colorValues.length; i++) {
                    if (!usedColors.includes(i)) {
                        return i;
                    }
                }
                return 0;
            }

            function addRacer() {
                colorIndex = getUnusedColorIndex();
                let newRacer = {
                    name: colorNames[colorIndex],
                    colorIndex: colorIndex,
                    place: [0, 0, 0],
                    total: 0
                };
                playerIndex = scoreCard.scores.length;
                scoreCard.scores.push(newRacer);
                addPlayerColumn(newRacer, playerIndex);
                saveScores();
                if (playerIndex >= 7) {
                    event.target.disabled = true;
                }
            }

        </script>
    </table>
    <button onclick="clearScores()">Clear Scores</button>
    <button id="addRacer" onclick="addRacer()">Add Racer</button>
    <button onclick="resetScoreCard()">Reset Score Card</button>

    <button onclick="SortColumnsByTotal()">Sort Columns by Total</button>



    <!-- The form -->
    <div class="form-popup" id="myForm">
        <!-- <form action="/action_page.php" class="form-container"> -->
        <form class="form-container">
            <label for="name"><b>Player Name</b></label>
            <input id="formNameField" type="text" name="name" required>
            <input type="checkbox" id="removePlayer"> Remove Player
            <button id="colorButton" type="button" class="btn" onclick="">Change Color</button>
            <button id="playerFormSaveButton" type="button" class="btn">Save</button>
            <button type="button" class="btn cancel" onclick="closeForm()">Cancel</button>
        </form>
    </div>
</body>


</html>